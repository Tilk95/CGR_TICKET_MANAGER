<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CGR Ticket Manager ‚Äì v3 (mobile‚Äëfirst)</title>
  <!-- PWA & Icons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180.png">
  <meta name="theme-color" content="#0b1020">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{--bg:#0b1020;--card:#141a2a;--muted:#9aa6bf;--accent:#8bd3ff;--ok:#19c37d;--warn:#ffb422;--danger:#ff5d5d}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;font:16px/1.35 system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#121a30,#0c1222);border-bottom:1px solid #1f2741}
    .wrap{max-width:740px;margin:0 auto;padding:14px}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted)}

    /* Toolbar haut */
    .topbar{display:flex;align-items:center;gap:10px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a345a;background:#182038;color:#fff;padding:10px 12px;border-radius:12px;font-size:15px}
    .btn.primary{background:#1a2a4f;border-color:#2d4e8a}
    .btn.ghost{background:transparent}

    /* Zone stats & recherche */
    .bar{display:flex;align-items:center;gap:10px;margin-top:10px}
    input[type="text"],select{flex:1;min-width:0;background:#0e152b;border:1px solid #2a345a;color:#fff;border-radius:12px;padding:10px 12px}

    /* Liste mobile des tickets */
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{background:var(--card);border:1px solid #1f2741;border-radius:14px;padding:12px;display:flex;gap:10px;align-items:center}
    .left{display:flex;flex-direction:column;align-items:flex-start;gap:4px;flex:1}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:14px}
    .meta{font-size:12px;color:var(--muted)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a345a;background:#0e162c;color:#cfe}
    .tag.type{color:#bcd}
    .tag.ok{border-color:#17634a;background:#0f2b22;color:#aef1d6}
    .tag.exp{border-color:#6a2b2b;background:#2b1212;color:#ffb3b3}
    .tag.used{border-color:#515151;background:#1b1b1b;color:#ccc}
    .item .actions{display:flex;gap:8px}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:14px}/* Modal d'import */
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.5);z-index:30}
    .modal.show{display:flex}
    .sheet{width:100%;max-width:740px;background:#0b1327;border-top-left-radius:14px;border-top-right-radius:14px;border:1px solid #23335a;padding:14px}
    .sheet h2{margin:0 0 8px 0;font-size:18px}
    .drop{border:2px dashed #39507f;border-radius:14px;padding:16px;text-align:left;background:#0b1a36}
    .drop.dragover{background:#0e244a;border-color:#5f86d0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px}

    /* Pass scannable plein √©cran */
    #pass{position:fixed;inset:0;background:#fff;color:#000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:50}
    #pass.show{display:flex}
    #pass .toolbar{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between}
    #pass .code{font-size:22px;letter-spacing:2px}
    #barcode{max-width:92vw}

    /* Desktop am√©liorations */
    @media (min-width:900px){
      body{font-size:15px}
      .wrap{max-width:960px}
    }
    /* Harmonisation du bandeau (header) en mode clair */
  [data-theme="light"] header{background:linear-gradient(180deg,#ffffff,#f5f7fb);border-bottom:1px solid var(--border);box-shadow:0 1px 0 rgba(15,23,42,.06)}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/fr.min.js"></script>
  <script>dayjs.locale('fr')</script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
<header>
  <div class="wrap topbar">
    <h1>üéüÔ∏è CGR Tickets</h1>
    <div class="spacer"></div>
    <button class="btn ghost" id="btnShowAll">Voir tous</button>
    <button class="btn primary" id="btnAdd">Ôºã Ajouter</button>
  </div>
  <div class="wrap bar">
    <div id="stats" class="muted">‚Äî</div>
  </div>
  <div class="wrap bar">
    <input id="q" type="text" placeholder="Recherche (CIN, Code Web)" />
  </div>
</header>

<main class="wrap">
  <div id="list" class="list"></div>
</main>

<!-- MODAL d'import -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h2>Ajouter des billets</h2>
      <button class="btn" id="closeModal">Fermer</button>
    </div>
    <div id="drop" class="drop" tabindex="0">
      D√©pose tes PDF CGR ici ou <label class="btn primary" for="file">Choisir des fichiers</label>
      <input id="file" type="file" accept="application/pdf" multiple hidden />
      <div class="small muted" style="margin-top:6px">Les doublons (m√™me code) sont ignor√©s.</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnImportJson">Importer JSON</button>
      <button class="btn warn" id="btnExportJson">Exporter JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" hidden />
    </div>
  </div>
</div>

<!-- PASS PLEIN √âCRAN POUR SCAN -->
<div id="pass" role="dialog" aria-modal="true">
  <div class="toolbar">
    <button class="btn" id="closePass">Fermer</button>
    <div>
      <button class="btn" id="fsToggle">Plein √©cran</button>
      <button class="btn" id="invertBg">Fond clair/sombre</button>
      <button class="btn warn" id="markUsed">Marquer utilis√©</button>
    </div>
  </div>
  <svg id="barcode"></svg>
  <div class="code" id="passCode">‚Äî</div>
  <div class="small muted" id="passMeta">‚Äî</div>
</div>

<script>
const $ = s => document.querySelector(s);
const on = (el,ev,fn) => el.addEventListener(ev,fn);
const LS_KEY = 'cgrTickets.v1';
let SHOW_ALL = false; // Par d√©faut: afficher seulement les disponibles

function loadDB(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return [] } }
function saveDB(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); render(); }
let DB = loadDB();

function fmtDate(d){ return dayjs(d).format('DD/MM/YYYY'); }
function isExpired(d){ return dayjs(d).endOf('day').isBefore(dayjs()); }

function ticketsAvailable(list){ return list.filter(r=>!r.used && !isExpired(r.validUntil)); }

function render(){
  const q = $('#q').value.trim().toUpperCase();
  let rows = DB.slice();
  if(!SHOW_ALL) rows = ticketsAvailable(rows);
  if(q){ rows = rows.filter(r=> r.code.toUpperCase().includes(q) || (r.codeweb||'').toUpperCase().includes(q)); }
  // Tri: d'abord expiration proche
  rows.sort((a,b)=> a.validUntil.localeCompare(b.validUntil));

  const list = $('#list'); list.innerHTML='';
  rows.forEach(r=>{
    const item = document.createElement('div');
    item.className = 'item';
    const status = r.used ? '<span class="tag used">utilis√©</span>' : (isExpired(r.validUntil)?'<span class="tag exp">expir√©</span>':'<span class="tag ok">disponible</span>');
    item.innerHTML = `
      <div class="left">
        <div>${status} <span class="tag type">${r.type||'?'}</span></div>
        <div class="code">${r.code}</div>
        <div class="meta">Valable jusqu'au ${fmtDate(r.validUntil)}${r.codeweb?` ‚Ä¢ Code Web ${r.codeweb}`:''}</div>
      </div>
      <div class="actions">
        ${(!r.used && !isExpired(r.validUntil))?'<button class="btn small" data-pass>üßæ Pass</button>':''}
        <button class="btn small" data-toggle>‚úîÔ∏é</button>
      </div>`;
    item.querySelector('[data-toggle]').onclick = ()=>{ r.used=!r.used; saveDB(DB); };
    const passBtn = item.querySelector('[data-pass]');
    if(passBtn) passBtn.onclick = ()=> openPass(r);
    list.appendChild(item);
  });
  const total = DB.length;
  const avail = ticketsAvailable(DB).length;
  const used = DB.filter(r=>r.used).length;
  const expired = DB.filter(r=>isExpired(r.validUntil)).length;
  $('#stats').innerHTML = SHOW_ALL
    ? `Tous les billets ‚Äî Total: <b>${total}</b> ‚Ä¢ Disponibles: <b>${avail}</b> ‚Ä¢ Expir√©s: <b>${expired}</b> ‚Ä¢ Utilis√©s: <b>${used}</b>`
    : `Tickets disponibles: <b>${avail}</b> (valables & non utilis√©s)`;
  $('#btnShowAll').textContent = SHOW_ALL ? 'Voir disponibles' : 'Voir tous';
}

// --- Modal Import ---
function openModal(){ $('#modal').classList.add('show'); }
function closeModal(){ $('#modal').classList.remove('show'); }
on($('#btnAdd'),'click',openModal);
on($('#closeModal'),'click',closeModal);

// Drag & drop
const drop = $('#drop');
;['dragenter','dragover'].forEach(ev=>on(drop,ev,e=>{e.preventDefault(); drop.classList.add('dragover')}));
;['dragleave','drop'].forEach(ev=>on(drop,ev,e=>{e.preventDefault(); drop.classList.remove('dragover')}));
on(drop,'drop', async e=>{const files=[...e.dataTransfer.files].filter(f=>f.type==='application/pdf'); await handleFiles(files)});
on($('#file'),'change', async e=>{ await handleFiles([...e.target.files]) });

// Export/Import JSON
on($('#btnExportJson'),'click',()=>{
  const blob = new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='cgr_tickets.json'; a.click(); URL.revokeObjectURL(url);
});

on($('#btnImportJson'),'click',()=> $('#importJsonFile').click());
on($('#importJsonFile'),'change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{ const arr = JSON.parse(txt); if(Array.isArray(arr)){ DB = arr; saveDB(DB); alert('Import JSON ok'); closeModal(); } }catch(err){ alert('JSON invalide'); }
});

// --- Parsing PDF via pdf.js ---
const CODE_RE = /CIN\d{5}[A-Z]\d{5}[A-Z0-9]{2}/g; // CIN50718P11777D0
const DATE_RE = /Valable\s+jusqu'?au\s*[:\-]?\s*(\d{2}[\/-]\d{2}[\/-]\d{4})/i;
const CODEWEB_RE = /CODE\s*WEB\s*[:\-]?\s*([A-Z0-9]{5,6})/i;
const ICE_HINT_RE = /ICE|PREMIUM\s*ICE/i;

async function parsePdf(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  const results = [];
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const text = content.items.map(i=>i.str).join(' ');
    const codes = [...text.matchAll(CODE_RE)].map(m=>({code:m[0], index:m.index||0}));
    if(codes.length===0) continue;
    const dm = text.match(DATE_RE);
    const validUntil = dm? dayjs(dm[1].replace(/\//g,'-').replace(/(\d{2})-(\d{2})-(\d{4})/,'$3-$2-$1')).format('YYYY-MM-DD') : null;
    const cwm = text.match(CODEWEB_RE);
    const codeweb = cwm? cwm[1].trim() : null;
    const type = ICE_HINT_RE.test(text)? 'ICE' : 'Standard';

    for(const c of codes){
      const core = c.code.slice(0,-2);
      const prefix = core.slice(0,8);
      const letter = core[8];
      const num = core.slice(9,14);
      results.push({ code: c.code, codeweb, type, validUntil, used:false, prefix, letter, num, source: file.name });
    }
  }
  return results;
}

function upsertTickets(tickets){
  const byCode = new Map(DB.map(x=>[x.code,x]));
  let added=0, updated=0;
  for(const t of tickets){
    if(!t.validUntil) continue;
    if(byCode.has(t.code)){
      const cur = byCode.get(t.code);
      if(!cur.codeweb && t.codeweb){ cur.codeweb = t.codeweb; updated++; }
      if(!cur.type && t.type){ cur.type = t.type; updated++; }
      if(cur.validUntil !== t.validUntil){ cur.validUntil = t.validUntil; updated++; }
    }else{
      DB.push(t); added++;
    }
  }
  saveDB(DB);
  alert(`Import termin√©: +${added} ajout(s), ${updated} mise(s) √† jour, total ${DB.length}.`);
  closeModal();
}

async function handleFiles(files){
  if(!files.length) return;
  drop.innerHTML = '‚è≥ Lecture‚Ä¶';
  const all=[];
  for(const f of files){
    try{ const items = await parsePdf(f); all.push(...items);}catch(err){ console.error(err); alert('Erreur lecture '+f.name); }
  }
  upsertTickets(all);
  // r√©tablir contenu drop
  drop.innerHTML = 'D√©pose tes PDF CGR ici ou <label class="btn primary" for="file">Choisir des fichiers</label>\n      <input id="file" type="file" accept="application/pdf" multiple hidden />\n      <div class="small muted" style="margin-top:6px">Les doublons (m√™me code) sont ignor√©s.</div>';
  // relier √† nouveau l'input
  $('#file').addEventListener('change', async e=>{ await handleFiles([...e.target.files]) });
}

// --- Pass scannable ---
const passEl = $('#pass');
const barcodeEl = $('#barcode');
let currentIdx = -1;

function openPass(ticket){
  currentIdx = DB.findIndex(t=>t.code===ticket.code);
  passEl.classList.add('show');
  JsBarcode(barcodeEl, ticket.code, {format:'CODE128', displayValue:false, height:140, width:2, margin:16});
  $('#passCode').textContent = ticket.code;
  $('#passMeta').textContent = `${ticket.type||'Type ?'} ‚Ä¢ Valable jusqu'au ${fmtDate(ticket.validUntil)}${ticket.used?' ‚Ä¢ d√©j√† marqu√© utilis√©':''}`;
}

function closePass(){ passEl.classList.remove('show'); if(document.fullscreenElement) document.exitFullscreen().catch(()=>{}); }

on($('#closePass'),'click',closePass);
on($('#fsToggle'),'click',()=>{ if(!document.fullscreenElement){ passEl.requestFullscreen().catch(()=>{});} else { document.exitFullscreen().catch(()=>{});} });
on($('#invertBg'),'click',()=>{ passEl.style.background = passEl.style.background==='#000' ? '#fff' : '#000'; passEl.style.color = passEl.style.background==='#000' ? '#fff' : '#000'; });
on($('#markUsed'),'click',()=>{ if(currentIdx>-1){ DB[currentIdx].used=true; saveDB(DB); closePass(); }});

// Interactions
on($('#btnShowAll'),'click',()=>{ SHOW_ALL=!SHOW_ALL; render(); });
on($('#q'),'input',render);

// Par d√©faut: vue "disponibles"
render();
</script>
</body>
</html>
